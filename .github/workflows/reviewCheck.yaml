name: review check bot

on:
  workflow_dispatch:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

env:
  TZ: "Asia/Tokyo"
  NODE_VERSION: "16.14.0"

jobs:

# test is ready?
  readyForTestChecker:
    runs-on: ubuntu-latest
    if: ${{!(github.event.pull_request.draft == true && contains(github.event.pull_request.labels.*.name, 'stop_ci'))}}
    steps:
      - run: echo this pull request is ready for review by team1

# BOT is reviewed ? or review required
  botReviewedChecker:
    needs: readyForTestChecker
#     if: ${{ !contains(github.event.pull_request.labels.*.name, 'BotReviewed') }}
    runs-on: ubuntu-latest
    steps:
      - run: echo bot is started review.

# check diff first. and add label
  labeler:
      permissions:
        contents: read
        pull-requests: write
      runs-on: ubuntu-latest
      needs: botReviewedChecker
      steps:
        - uses: actions/labeler@v4
          with:
            repo-token: "${{ secrets.GITHUB_TOKEN }}"
            configuration-path: ".github/config/labeler.yaml"
            sync-labels: true

# front 
## ä½™ç™½ã®ç®¡ç†å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ä½™ç™½ãŒãªã„ã€‚
## ãƒ†ãƒ¼ãƒžã«ãªã„è‰²ã€‚ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã®ã¹ãŸæ›¸ã
## importå…ˆã€ãƒ•ã‚¡ã‚¤ãƒ«ã®ç½®ãå ´æ‰€ã€‚

# front checker
  front:
    needs: botReviewedChecker
    name: frontEnd Checker
    runs-on: ubuntu-latest
    steps:
      ## setup for test
      - uses: actions/checkout@v2
      - uses: technote-space/get-diff-action@v6
        with:
          PATTERNS: |
            +(src|__tests__)/**/*.+(ts|tsx)
          FILES: |
            yarn.lock
            .eslintrc
          RELATIVE: 'sandbox'
      - run: echo ${{ env.GIT_DIFF }}
      
      ## cache yarn
      - uses: actions/setup-node@v2
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: get yarn cache dir path
        id: yarn-cache-dir-path
        run: echo "::set-output name=dir::$(yarn cache dir)"    
      - uses: actions/cache@v3
        id: yarn-cache # use this to check for `cache-hit` (`steps.yarn-cache.outputs.cache-hit != 'true'`)
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-
      - name: Install Package dependencies
        working-directory: sandbox
        run: yarn install
#         if: env.GIT_DIFF

      ## lintãŒã¨ãŠã‚‹ã“ã¨
      ## format 
      - name: Check code style and lint
        working-directory: sandbox
        run: yarn lint        
        # Check only source files with differences
#         run: yarn lint ${{ env.GIT_DIFF_FILTERED }}
#         if: env.GIT_DIFF && !env.MATCHED_FILES
      ## tscãŒé€šã‚‹ã“ã¨
      - name: tsc
        working-directory: sandbox
        run: yarn tsc
        ## testãŒã¨ãŠã‚‹ã“ã¨
#       - name: test 
#         working-directory: sandbox
#         run: yarn test
# coverageã‚‚ã¿ãŸã„ã€‚
# 


# backend
## ã’ã«å€‹äººæƒ…å ±ãŒå‡ºã¦ã„ãªã„ãªã©ã€ã’ã®æƒ…å ±ãƒã‚§ãƒƒã‚¯
## ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†


# api 
## äº’æ›æ€§ãƒã‚§ãƒƒã‚¯ã€‚ã§ãã‚‹ã®ã‹ãªâ€¦
## å‘½åè¦å‰‡ã€‚ã“ã‚Œã¯ã§ããã†ã€‚

# common
## è²¬å‹™åˆ†é›¢ã€å‘½åï¼Ÿ
## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°â€¦ã“ã‚Œã‚‚ã¾ãšã¯ã©ã®ã‚ˆã†ãªæ–¹é‡ãªã®ã‹ã‚’æ±ºã‚ãªã„ã¨ã„ã‘ãªã„ã€‚è¨€èªžåŒ–
## é‡è¤‡,DRYãªã‚³ãƒ¼ãƒ‰
## ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å¤‰æ›´æ¤œçŸ¥ã€‚åˆ¥ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã‚‚ä¿®æ­£ãŒå¿…è¦ãªã®ã§ã¯ï¼Ÿã¨ã„ã†ææ¡ˆ

# ç‰¹å®šã®ãƒ©ãƒ™ãƒ«ãŒã¤ã„ã¦ã„ãŸå ´åˆã€ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã€‚å·®åˆ†ãŒã‚ã‚‹ã“ã¨ã€‚
## ddl to jooq generate
## releaseé †ç•ªã‚„ãã®ãƒ«ãƒ¼ãƒ«

# playbookã®æœ‰ç„¡ã€‚åå‰ã®ãƒ«ãƒ¼ãƒ«ãŒãªã„ã¨ã¿ã‚‹ã®é›£ã—ãã†ã€‚


# ã‚¤ãƒ³ãƒ•ãƒ©
## è‰²ã€…è¦³ç‚¹ãŒã‚ã‚‹ã®ã§ãŠã„ãŠã„ã‚„ã‚‹ã€‚





#   output result
## å®Ÿè¡Œçµæžœã‚’ã©ã†ã™ã‚Œã°æ¸¡ã›ã‚‹ã®ã‹ã‚’ç¢ºèªã™ã‚‹ã€‚
  commentResult:
    runs-on: ubuntu-latest
    if: always()
    needs:
      - labeler
      - front
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/github-script@v6
        env: 
          DIFF_RESULT: ${{ env.GIT_DIFF }}
        with:
          script: |
            const { DIFF_RESULT } = process.env
            // Get the existing comments.
            const {data: comments} = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.number,
            });
            
            const botComment = comments.find(comment => comment.user.id === 41898282);        
            const commentBody = `Hello ðŸ‘‹ recheck is done ! (${{ github.sha }}) 
              diff is ...
               ${DIFF_RESULT}
             `
             
            
            if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: commentBody
                })
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.number,
                body: `ðŸ‘‹ first check is done `
              })
            }
            
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['BotReviewed']
              })
